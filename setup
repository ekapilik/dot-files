#!/usr/bin/bash

set -e

script_dir="$(dirname "$(realpath "$0")")"

#### Install latest NodeJS ####
current_node=$(node -v 2>/dev/null || echo "v0.0.0")
required_node="v20.0.0"

if [ "$(printf '%s\n' "$required_node" "$current_node" | sort -V | head -n1)" != "$required_node" ]; then
  echo "Upgrading Node.js to 20.x..."
  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
  sudo apt-get install -y nodejs
else
  echo "Node.js version $current_node already satisfies 20.x+ requirement."
fi

##### INSTALL LATEST NEOVIM #####
echo "Ensuring add-apt-repository is available..."
sudo apt-get update
sudo apt-get install -y software-properties-common

echo "Adding Neovim PPA (unstable) for latest version..."
sudo add-apt-repository -y ppa:neovim-ppa/unstable
sudo apt-get update

# Ensure Neovim is >= 0.10.0
current_nvim=$(nvim --version 2>/dev/null | head -n1 | awk '{print $2}' | sed 's/^v//' | sed 's/[^0-9.].*$//' )
current_nvim=${current_nvim:-0.0.0}
required_nvim="0.10.0"
if [ "$(printf '%s\n' "$required_nvim" "$current_nvim" | sort -V | head -n1)" != "$required_nvim" ]; then
  echo "Upgrading Neovim to >= $required_nvim ..."
  sudo apt-get install -y neovim neovim-runtime
else
  echo "Neovim version v$current_nvim already satisfies $required_nvim+ requirement."
fi

# Install Neovim and dependencies
packages=(
  tmux
  nodejs
  python3
  python3-pip
  stow
  pipx
  clang-format
  clangd
  ripgrep
  unzip
  tmux
)

if ! dpkg -s "${packages[@]}" &> /dev/null; then
  sudo apt-get update && sudo apt-get install -y "${packages[@]}"
else
  echo "All packages are already installed."
fi

# Enable corepack and prepare npm (avoids conflict with apt's npm)
echo "Setting up npm using corepack..."
sudo corepack enable
sudo corepack prepare npm@latest --activate

# pipx
pipx ensurepath
pipx install cmake-language-server

# Recursively creates symbolic links to nvim files in ~/ for .config set up
pushd $script_dir
echo "stowing dotfiles..."
stow -t $HOME nvim/
stow -t $HOME tmux/
popd

# ensure local user directories exist
mkdir -p $HOME/.local/share/
mkdir -p $HOME/.local/state/
# Fix permissions
sudo chown -R $(id -u):$(id -g) $HOME/.local/share/
sudo chown -R $(id -u):$(id -g) $HOME/.local/state/

##### BASHRC #####
declare -a ALIASES=(
"alias nv='nvim'"
"alias v='nvim'"
"alias cb='cargo build'"
"alias cr='cargo run'"
"alias ct='cargo test'"
)
bashrc_changed=0

for alias in "${ALIASES[@]}"; do
  if [ $(cat ~/.bashrc | grep "$alias" | wc -l) -eq 0 ]; then
    echo "Adding $alias to ~/.bashrc ..."
    echo $alias >> ~/.bashrc
    bashrc_changed=1
  fi
done

if [ $bashrc_changed -eq 1 ]; then
  echo "~/.bashrc was changed. Remember to run:"
  echo "source ~/.bashrc"
fi

echo -e "\nâœ… Setup complete. Run 'nvim --version' to confirm you're on v0.10+."
